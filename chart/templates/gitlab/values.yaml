{{- if .Values.gitlab.enabled }}
{{- include "values-secret" (dict "root" $ "package" .Values.gitlab "name" "gitlab" "defaults" (include "dorkomen.defaults.gitlab" .)) }}
{{- end }}

{{- define "dorkomen.defaults.gitlab" -}}
# GitLab default values
{{- $domainName := default .Values.domain .Values.hostname }}
hostname: {{ $domainName }}
domain: {{ $domainName }}

global:
  edition: ce

  hosts:
    domain: {{ $domainName }}
    https: true
    gitlab:
      name: gitlab.{{ $domainName }}
    registry:
      name: registry.{{ $domainName }}
    minio:
      name: minio.{{ $domainName }}

  {{- if (include "imagePullSecret" .) }}
  imagePullSecrets:
    - name: private-registry
  {{- end }}

  ingress:
    configureCertmanager: false
    enabled: true
    class: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.middlewares: gitlab-redirect-to-https@kubernetescrd
    tls:
      enabled: true
      secretName: gitlab-tls

  # Use bundled MinIO for object storage
  minio:
    enabled: true

  # External PostgreSQL configuration
  psql:
    host: gitlab-postgresql.gitlab.svc.cluster.local
    port: 5432
    username: gitlab
    database: gitlabhq_production
    password:
      secret: gitlab-postgresql-password
      key: postgresql-password

  # External Redis configuration
  redis:
    host: gitlab-redis-master.gitlab.svc.cluster.local
    port: 6379
    password:
      enabled: true
      secret: gitlab-redis-password
      key: redis-password

  # Shell settings
  shell:
    port: 22

  # Workhorse
  workhorse:
    serviceName: webservice-default

  # Registry
  registry:
    enabled: true

# Certmanager - disabled, bring your own certs
certmanager:
  install: false

# NGINX Ingress - disabled, use existing ingress controller
nginx-ingress:
  enabled: false

# Prometheus - disabled, use external monitoring
prometheus:
  install: false

# GitLab Runner - installed separately
gitlab-runner:
  install: false

# Grafana - disabled
grafana:
  enabled: false

# Components
gitlab:
  gitaly:
    persistence:
      enabled: true
      size: 50Gi

  webservice:
    minReplicas: 1
    maxReplicas: 2
    workerProcesses: 2
    resources:
      limits:
        memory: 3Gi
      requests:
        cpu: 300m
        memory: 2.5Gi

  sidekiq:
    minReplicas: 1
    maxReplicas: 2
    resources:
      limits:
        memory: 2Gi
      requests:
        cpu: 100m
        memory: 1Gi

  gitlab-shell:
    minReplicas: 1
    maxReplicas: 2

  toolbox:
    enabled: true

# Registry
registry:
  enabled: true
  hpa:
    minReplicas: 1
    maxReplicas: 2

# PostgreSQL - disable bundled, use external or install separately
postgresql:
  install: false

# Redis - disable bundled, use external or install separately
redis:
  install: false

# MinIO
minio:
  persistence:
    enabled: true
    size: 10Gi

{{- end -}}
